<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>🔐 Private Chat (Short Code Version)</title>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f0f8ff;
    }
    h2 { color: #222; }
    #messages {
      border: 1px solid #ccc;
      background: #fff;
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }
    input[type="text"] {
      width: 80%;
      padding: 10px;
    }
    button {
      padding: 10px;
      margin: 5px 0;
      font-size: 14px;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin-top: 5px;
      font-family: monospace;
    }
  </style>
</head>
<body>

  <h2>🔐 Short Code Chat</h2>

  <div id="messages"></div>
  <input type="text" id="chatInput" placeholder="Type message..." />
  <button onclick="sendMessage()">Send</button>

  <h3>1. Create Chat Offer</h3>
  <button onclick="createOffer()">Create Offer</button>
  <textarea id="offerBox" placeholder="Copy this short code to your friend"></textarea>

  <h3>2. Paste Offer → Generate Answer</h3>
  <textarea id="incomingOffer" placeholder="Paste friend's offer code"></textarea>
  <button onclick="createAnswer()">Answer</button>
  <textarea id="answerBox" placeholder="Copy this answer code to your friend"></textarea>

  <h3>3. Paste Answer & Connect</h3>
  <textarea id="incomingAnswer" placeholder="Paste friend's answer code"></textarea>
  <button onclick="connect()">Connect</button>

  <script>
    let peer;
    let isInitiator = false;

    function encode(data) {
      return btoa(JSON.stringify(data));
    }

    function decode(str) {
      return JSON.parse(atob(str));
    }

    function createOffer() {
      isInitiator = true;
      peer = new SimplePeer({ initiator: true, trickle: false });

      peer.on('signal', data => {
        document.getElementById('offerBox').value = encode(data);
      });

      setupEvents();
    }

    function createAnswer() {
      const offerCode = document.getElementById('incomingOffer').value.trim();
      if (!offerCode) return alert("Paste offer code first.");

      peer = new SimplePeer({ initiator: false, trickle: false });
      peer.signal(decode(offerCode));

      peer.on('signal', data => {
        document.getElementById('answerBox').value = encode(data);
      });

      setupEvents();
    }

    function connect() {
      if (!isInitiator) {
        alert("Only the offer-creator should click Connect.");
        return;
      }

      const answerCode = document.getElementById('incomingAnswer').value.trim();
      if (!answerCode) return alert("Paste answer code first.");

      try {
        peer.signal(decode(answerCode));
      } catch (e) {
        alert("Invalid code. Please try again.");
        console.error(e);
      }
    }

    function sendMessage() {
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (msg && peer?.connected) {
        peer.send(msg);
        addMessage("🟢 You: " + msg);
        input.value = '';
      }
    }

    function setupEvents() {
      peer.on('connect', () => addMessage("✅ Secure connection established."));
      peer.on('data', data => addMessage("🔵 Friend: " + data));
      peer.on('error', err => addMessage("❌ Error: " + err.message));
      peer.on('close', () => addMessage("🔕 Chat ended."));
    }

    function addMessage(msg) {
      const box = document.getElementById('messages');
      const p = document.createElement('p');
      p.textContent = msg;
      box.appendChild(p);
      box.scrollTop = box.scrollHeight;
    }
  </script>
</body>
</html>
